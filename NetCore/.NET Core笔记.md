# .NET Core 笔记

## 从CLI开始
CLI（command line interface）

## ASP.NET Core
### 启动 Web App
#### Program.cs
#### Startup.cs

## 依赖注入 Dependency Injection 
IoC(Inversion of Control)容器的职责：  
- 控制系统中所以对象的创建
- 注入正确的依赖
- 管理创建的对象的生命线

有三种方式指定服务的生命周期：  
1. Transient
用作轻量级的服务，不需要保持任何状态，快速实例化，每次需要时都会创建一个类的新实例。  
``` c#
services.AddTransient<IClock,Clock>()
```
2. Scoped
一般是用在那些需要保持状态的服务，这些状态只对当前请求有用，像仓储类和数据访问类。  
作为scoped注册的Services会在请求开始的时候被创建，同一个请求中每次需要这个类的时候都会重用这个实例。  
添加方法：
``` c#
services.AddScoped<IRepository, Repository>()
```
3. Singleton
服务作为单例被注册。服务的实例在第一次需要时被创建，在整个之后的应用程序中都会被重用。这样的Services一般会保存一个应用程序状态，就像内存内缓存或者类似的方式。
``` c#
services.AddSingleton<IApplicationCache, ApplicationCache>()
```
### 使用依赖注入
使用 ASP.NET Core MVC 需要引入Nuget包 `Microsoft.AspNetCore.Mvc`。

## 环境 Environments
每个应用程序都至少要处理至少2个或更多的环境，如开发环境、生产环境，和一些情况下的模拟环境。  

### 旧方式
web.config **IHostingEnvironment**和预处理指令。   
发生在编译阶段。

### 新方式
IHostingEnvironment 接口。  
IHostingEnvironment 的实现读取一个指定的名叫 **IHostingEnvironment** 的环境变量，并检查它的值。如果是 **Development**，表示运行在开发环境，以此类推。  
这种方法可以在运行阶段在不同的环境之间切换，而不像旧的方式只能在编译阶段处理。

Startup类也可以使用约定的命名方式，来配置环境。如当前环境是Development，那么新建一个 `StartupDevelopment` 类，则 `Main` 方法中的`.UseStartup<Startup>`，能自动切换不同的类，只要遵循正确的约定（方法名+环境名）。  
同样的约定也适用于`Startup`中的类，如`ConfigureDevelopment`，它也会在`Development`环境中替换原始的方法。  

### 创建自定义的环境
比如需要一个`QualityAssurance`的环境，则可以扩展 `IHostingEnvironment` 的方法： 
``` c#
using Microsoft.AspNetCore.Hosting;
namespace Syncfusion.Asp.Net.Core.Succinctly.Environments.Extensions {
public static class HostingEnvironmentExtensions 
{
    public static bool IsQualityAssurance(this IHostingEnvironment hostingEnvironment)
    {
        return hostingEnvironment.EnvironmentName == "QualityAssurance";
    } 
}
```
**IHostingEnvironment** 也可以用在视图和配置文件中。  

## 静态文件
Nuget包 `Microsoft.AspNetCore.StaticFiles`
``` c#
// 使用静态文件，静态文件需要存放在wwwroot文件夹下
app.UseStaticFiles();
```
或
``` c#
// 一个单页应用里，当访问域名时需要返回默认文档（default.html,default.htm,index.html,index.htm)
// 如果不设置UseFileServer，显示一个空白页
app.UseFileServer();    
```

## 错误处理和异常页面
从某种角度来看，你可以说一个好的应用程序要能够在最短的时间内识别错误并将最好的反馈返回给用户。  
日志框架、异常处理、自定义错误页面。  

### 开发者异常页面
Nuget包 `Microsoft.AspNetCore.Diagnostics`  
``` c#
if (_env.IsDevelopment())
{
    app.UseDeveloperExceptionPage(); 
} 
else 
{
    app.UseStatusCodePagesWithRedirects("~/errors/{0}.html"); 

    // app.UseStatusCodePagesWithReExecute("~/errors/{0}");     // MVC
}
```

## 配置文件  

### 两个规则
- 规则1： 每个环境单独对应一个json文件  
`appsettings.json` 和 `appsettings.Development.json`、`appsettings.Production.json`。  

- 规则2：每个文件中只写自己独有的配置项  
ASP.NET Core 会自动合并这些文件，只覆盖在相应环境文件中指定的配置项。  

示例：  
appsettings.json
``` json
{
  "database": {
    "databaseName": "my-db-name",
    "serverHost": "mySqlHost",
    "port": 1433,
    "username": "username",
    "password": "password"
  },
  "facebook": {
    "appId": "app-id",
    "appSecret": "app-secret"
  },
  "smtp": {
    "host": "mysuperhost.mysuperdomain.com",
    "username": "imperugo@gmail.com",
    "password": "my-super-secret-password",
    "enableSsl": true,
    "port": 587
  }
}
```
appsettings.Development.json
``` json
{
  "database": {
    "databaseName": "my-development-db-name"
  }
}
```
appsettings.Production.json
``` json
{
  "database": {
    "databaseName": "my-production-db-name"
  }
}
```

### 配置类
创建一个结构和JSON结构一致的C#类，通过类以更舒服的方式得到配置信息。  
``` C#
public class Configuration
{
    public DatabaseConfiguration Database { get; set; }
    public FacebookConfiguration Facebook { get; set; }
    public SmtpConfiguration SmtpConfiguration { get; set; }
}

public class DatabaseConfiguration
{
    public string DatabaseName { get; set; }
    public string ServerHost { get; set; }
    public int Port { get; set; }49
    public string Username { get; set; }
    public string Password { get; set; }

    public string ConnectionString => $"Server=tcp:{ServerHost},{Port
        };Database={DatabaseName};User ID={Username};Password={Password};Encrypt=
        True;TrustServerCertificate=False;Connection Timeout=30;";
}

......
```

### 初始化配置类的实例
在`Startup`类中编写代码。  
需要引入以下包：  
```
Microsoft.Extensions.Configuration.EnvironmentVariables
Microsoft.Extensions.Configuration.FileExtensions
Microsoft.Extensions.Configuration.Json
Microsoft.Extensions.Configuration.Binder
```
代码如下：
``` C#
private readonly Configuration configuration;

public Startup(IHostingEnvironment env)
{
    var builder = new ConfigurationBuilder()
        .SetBasePath(env.ContentRootPath)
        .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
        .AddJsonFile($"appsettings.{env.EnvironmentName}.json", optional: true)
        .AddEnvironmentVariables()
        .Build();

    configuration = new Configuration();
    builder.Bind(configuration);
}
```

### 注入配置对象
将配置类的示例以单例的方式注入，这样可以在应用程序的任何需要配置信息的地方使用，例如Controller、Service等。
``` C#
public void ConfigureServices(IServiceCollection services)
{
    services.AddSingleton(configuration);
}

public class MySimpleService
{
    private readonly Configuration configuration;
    public MySimpleService(Configuration configuration)
    {
        this.configuration = configuration;
    }
}
```